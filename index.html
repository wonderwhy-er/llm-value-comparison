<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Value Comparison: Local vs Subscription vs API</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            padding: 2rem;
            line-height: 1.6;
        }
        h1 {
            text-align: center; font-size: 2rem; margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #00ff88, #7c3aed, #ff6b6b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab {
            padding: 0.75rem 1.5rem; cursor: pointer; color: #888;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab:hover { color: #e0e0e0; }
        .tab.active { color: #00ff88; border-bottom-color: #00ff88; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .oss-banner {
            background: linear-gradient(90deg, rgba(0,255,136,0.1), rgba(124,58,237,0.1));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            padding: 0.75rem 1.5rem; margin-bottom: 1.5rem;
            text-align: center; font-size: 0.8rem;
        }
        .oss-banner a { color: #00ff88; }
        
        .warning-box {
            background: rgba(255,100,100,0.15); border: 1px solid rgba(255,100,100,0.4);
            border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1.5rem;
            font-size: 0.75rem; color: #ffaaaa;
        }
        .warning-box strong { color: #ff6b6b; }
        
        .global-settings {
            background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3);
            border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 2rem;
        }
        .global-settings h3 { color: #ffc800; margin-bottom: 0.75rem; font-size: 0.9rem; }
        .settings-row { display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
        .setting-group label { display: block; font-size: 0.7rem; color: #999; margin-bottom: 0.25rem; }
        .global-settings select, .global-settings input {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255, 200, 0, 0.4);
            color: #ffc800; padding: 0.4rem 0.8rem; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;
        }
        .chart-section h2 { text-align: center; margin-bottom: 1rem; }
        .chart-controls { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .chart-controls select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            color: #e0e0e0; padding: 0.4rem 0.8rem; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem;
        }
        .chart-wrapper { position: relative; height: 500px; }
        
        /* Data Tables */
        .data-table-section { margin-bottom: 2rem; }
        .data-table-section h3 { 
            color: #00ff88; margin-bottom: 1rem; font-size: 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 0.75rem;
            background: rgba(255,255,255,0.02); border-radius: 8px; overflow: hidden;
        }
        .data-table th {
            background: rgba(255,255,255,0.05); padding: 0.75rem;
            text-align: left; color: #888; font-weight: 500;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .data-table td {
            padding: 0.6rem 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .data-table tr:hover td { background: rgba(255,255,255,0.03); }
        .data-table a { color: #88f; text-decoration: none; }
        .data-table a:hover { text-decoration: underline; }
        .confidence-low { color: #ff6b6b; }
        .confidence-medium { color: #ffc800; }
        .confidence-high { color: #00ff88; }
        .edit-link { 
            font-size: 0.65rem; color: #666; margin-left: 0.5rem;
        }
        .edit-link:hover { color: #00ff88; }
        
        /* Calculator explanation cards */
        .calc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media (max-width: 900px) { .calc-grid { grid-template-columns: 1fr; } }
        .calc-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 1rem;
        }
        .calc-card h4 { margin-bottom: 0.75rem; font-size: 0.85rem; }
        .calc-card.local { border-color: rgba(0,255,136,0.3); }
        .calc-card.local h4 { color: #00ff88; }
        .calc-card.api { border-color: rgba(255,107,107,0.3); }
        .calc-card.api h4 { color: #ff6b6b; }
        .calc-card.sub { border-color: rgba(124,58,237,0.3); }
        .calc-card.sub h4 { color: #7c3aed; }
        .calc-card select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: #e0e0e0; padding: 0.4rem; border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.75rem;
        }
        .calc-steps { font-size: 0.7rem; line-height: 1.8; }
        .calc-step { color: #888; }
        .calc-step .num { color: #ffc800; }
        .calc-step .result { color: #fff; }
        .calc-final { 
            margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .calc-final .value { font-size: 1.25rem; font-weight: 700; }
        .calc-final .label { font-size: 0.6rem; color: #666; }
        
        /* Results ranking */
        .results-section { margin-top: 1.5rem; }
        .results-section h3 { margin-bottom: 1rem; font-size: 0.9rem; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° LLM Value Comparison</h1>
        <p class="subtitle">Quality-Adjusted Tokens per Dollar ‚Äî Local vs Subscription vs API</p>
        
        <div class="oss-banner">
            üìñ <strong>Open Source (MIT)</strong> ‚Äî 
            <a href="https://github.com/wonderwhy-er/llm-value-comparison" target="_blank">GitHub</a> | 
            Contribute model data via Pull Request
        </div>
        
        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" data-tab="calculator">üìä Calculator</div>
            <div class="tab" data-tab="chart">üìà Timeline Chart</div>
            <div class="tab" data-tab="data">üìã Raw Data</div>
        </div>
        
        <!-- TAB: CALCULATOR -->
        <div id="tab-calculator" class="tab-content active">
            <div class="warning-box">
                <strong>‚ö†Ô∏è Subscription data is estimated!</strong> 
                Providers don't publish exact token limits. See Data tab for sources and confidence levels.
            </div>
            
            <div class="global-settings">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="settings-row">
                    <div class="setting-group">
                        <label>Hardware (for Local)</label>
                        <select id="hardware"></select>
                    </div>
                    <div class="setting-group">
                        <label>Hours/day (Local)</label>
                        <input type="number" id="hoursPerDay" value="16" min="1" max="24" style="width: 70px;">
                    </div>
                    <div class="setting-group">
                        <label>Comparison Period</label>
                        <select id="periodYears">
                            <option value="1">1 Year</option>
                            <option value="2">2 Years</option>
                            <option value="3" selected>3 Years</option>
                            <option value="5">5 Years</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>Quality Benchmark</label>
                        <select id="benchmark"></select>
                    </div>
                </div>
            </div>
            
            <!-- Methodology explanation -->
            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:1rem;margin-bottom:1.5rem;font-size:0.75rem;line-height:1.7">
                <h3 style="color:#ffc800;margin-bottom:0.75rem;font-size:0.85rem">üìê Methodology: Quality-Adjusted Tokens per Dollar</h3>
                
                <p style="color:#aaa;margin-bottom:1rem">Not all tokens are equal ‚Äî a token from a smarter model is worth more than one from a weaker model. We calculate <strong style="color:#fff">"quality tokens"</strong> by multiplying raw token counts by model quality (from benchmarks). Then we divide by cost to get <strong style="color:#fff">quality-adjusted tokens per dollar</strong> ‚Äî a fair way to compare completely different pricing models.</p>
                
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem">
                    <div style="border-left:2px solid #00ff88;padding-left:0.75rem">
                        <div style="color:#00ff88;font-weight:600;margin-bottom:0.5rem">üñ•Ô∏è Local</div>
                        <div style="color:#888;font-size:0.65rem">
                            Take tokens/second ‚Üí calculate tokens/day you can generate ‚Üí multiply by years of usage ‚Üí multiply by quality score ‚Üí divide by one-time hardware cost.
                        </div>
                    </div>
                    <div style="border-left:2px solid #7c3aed;padding-left:0.75rem">
                        <div style="color:#7c3aed;font-weight:600;margin-bottom:0.5rem">üí≥ Subscription</div>
                        <div style="color:#888;font-size:0.65rem">
                            Estimate average tokens/day from usage limits ‚Üí multiply by years ‚Üí multiply by quality score ‚Üí divide by total subscription cost over that period.
                        </div>
                    </div>
                    <div style="border-left:2px solid #ff6b6b;padding-left:0.75rem">
                        <div style="color:#ff6b6b;font-weight:600;margin-bottom:0.5rem">üîå API</div>
                        <div style="color:#888;font-size:0.65rem">
                            Take tokens per dollar (1M √∑ price) ‚Üí multiply by quality score. Simple ‚Äî you pay exactly for what you use.
                        </div>
                    </div>
                </div>
                
                <p style="color:#666;margin-top:1rem;font-size:0.65rem"><strong>Quality scores:</strong> Percentage benchmarks (Aider, LiveBench) use the score directly. ELO rankings are normalized to 0-100% where 1000 ELO = 0% and 1500 ELO = 100%.</p>
            </div>
            
            <!-- Calculation explanation cards -->
            <div class="calc-grid">
                <div class="calc-card local">
                    <h4>üñ•Ô∏è Local</h4>
                    <select id="calcLocal"></select>
                    <div class="calc-steps" id="calcLocalSteps"></div>
                    <div class="calc-final">
                        <div class="value" style="color:#00ff88" id="calcLocalValue">-</div>
                        <div class="label">quality-adjusted tokens per $</div>
                    </div>
                </div>
                <div class="calc-card sub">
                    <h4>üí≥ Subscription ‚ö†Ô∏è</h4>
                    <select id="calcSub"></select>
                    <div class="calc-steps" id="calcSubSteps"></div>
                    <div class="calc-final">
                        <div class="value" style="color:#7c3aed" id="calcSubValue">-</div>
                        <div class="label">quality-adjusted tokens per $</div>
                    </div>
                </div>
                <div class="calc-card api">
                    <h4>üîå API</h4>
                    <select id="calcApi"></select>
                    <div class="calc-steps" id="calcApiSteps"></div>
                    <div class="calc-final">
                        <div class="value" style="color:#ff6b6b" id="calcApiValue">-</div>
                        <div class="label">quality-adjusted tokens per $</div>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h3>üìä All Options Ranked</h3>
                <div id="calculatorContent">Loading data...</div>
            </div>
        </div>
        
        <!-- TAB: CHART -->
        <div id="tab-chart" class="tab-content">
            <div class="chart-section">
                <h2>Value Over Time by Provider</h2>
                <div class="chart-controls">
                    <select id="chartBenchmark"></select>
                    <select id="chartType">
                        <option value="all">All Types</option>
                        <option value="api">API Only</option>
                        <option value="local">Local Only</option>
                        <option value="subscription">Subscription Only</option>
                    </select>
                    <select id="chartProvider">
                        <option value="all">All Providers</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="valueChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- TAB: DATA -->
        <div id="tab-data" class="tab-content">
            <div class="data-table-section">
                <h3>ü§ñ Models <a href="https://github.com/wonderwhy-er/llm-value-comparison/tree/main/data/models" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableModels">
                    <thead><tr><th>Model</th><th>Provider</th><th>Release</th><th>Model Card</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="data-table-section">
                <h3>üìä Benchmark Scores <a href="https://github.com/wonderwhy-er/llm-value-comparison/tree/main/data/models" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableBenchmarks">
                    <thead><tr><th>Model</th><th>Arena ELO</th><th>Aider</th><th>LiveBench</th><th>MMLU</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="data-table-section">
                <h3>üîå API Pricing <a href="https://github.com/wonderwhy-er/llm-value-comparison/tree/main/data/models" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableApi">
                    <thead><tr><th>Model</th><th>Input $/M</th><th>Output $/M</th><th>Source</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="data-table-section">
                <h3>üñ•Ô∏è Local Performance <a href="https://github.com/wonderwhy-er/llm-value-comparison/tree/main/data/models" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableLocal">
                    <thead><tr><th>Model</th><th>Hardware</th><th>Tok/s</th><th>Quant</th><th>VRAM</th><th>Source</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="data-table-section">
                <h3>üí≥ Subscriptions <span style="color:#ff6b6b">(‚ö†Ô∏è Estimated)</span> <a href="https://github.com/wonderwhy-er/llm-value-comparison/tree/main/data/models" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableSubs">
                    <thead><tr><th>Model</th><th>Subscription</th><th>$/mo</th><th>Tok/day</th><th>Confidence</th><th>Notes</th><th>Source</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="data-table-section">
                <h3>üîß Hardware <a href="https://github.com/wonderwhy-er/llm-value-comparison/blob/main/data/hardware.json" class="edit-link" target="_blank">[Edit on GitHub]</a></h3>
                <table class="data-table" id="tableHardware">
                    <thead><tr><th>Hardware</th><th>Price</th><th>VRAM</th><th>Year</th><th>Source</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    // Global state
    let DATA = { models: {}, hardware: {}, benchmarks: {} };
    let chart = null;
    
    const PROVIDER_COLORS = {
      'OpenAI': '#10a37f', 'Anthropic': '#d4a574', 'Google': '#4285f4',
      'DeepSeek': '#ff6b6b', 'Meta': '#0668E1', 'Alibaba': '#ff6a00',
      'Mistral': '#ff7000', 'Microsoft': '#00bcf2',
    };
    
    function formatNum(n) {
      if (n === null || n === undefined) return '-';
      if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(0) + 'K';
      return n.toFixed(0);
    }
    
    // Load all data from JSON files
    async function loadData() {
      try {
        // Load all 3 files in parallel
        const [modelsRes, hwRes, bmRes] = await Promise.all([
          fetch('data/models.json'),
          fetch('data/hardware.json'),
          fetch('data/benchmarks.json')
        ]);
        
        DATA.models = await modelsRes.json();
        DATA.hardware = await hwRes.json();
        DATA.benchmarks = await bmRes.json();
        
        console.log('Data loaded:', DATA);
        init();
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('calculatorContent').innerHTML = 
          `<div class="warning-box">Error loading data: ${err.message}</div>`;
      }
    }
    
    function init() {
      // Populate hardware dropdown
      const hwSelect = document.getElementById('hardware');
      Object.entries(DATA.hardware).forEach(([id, hw]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${hw.name} ($${hw.price})`;
        hwSelect.appendChild(opt);
      });
      
      // Populate benchmark dropdown (only recommended ones)
      const bmSelect = document.getElementById('benchmark');
      const chartBmSelect = document.getElementById('chartBenchmark');
      
      // Add combined option first
      const combinedOpt = document.createElement('option');
      combinedOpt.value = '_combined';
      combinedOpt.textContent = '‚ö° Combined (Average All)';
      bmSelect.appendChild(combinedOpt);
      
      const combinedOpt2 = document.createElement('option');
      combinedOpt2.value = '_combined';
      combinedOpt2.textContent = '‚ö° Combined (Average All)';
      chartBmSelect.appendChild(combinedOpt2);
      
      Object.entries(DATA.benchmarks).filter(([,b]) => b.recommended).forEach(([id, bm]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = bm.name;
        bmSelect.appendChild(opt);
        
        const opt2 = document.createElement('option');
        opt2.value = id;
        opt2.textContent = bm.name;
        chartBmSelect.appendChild(opt2);
      });
      
      // Populate calculator dropdowns
      populateCalcDropdowns();
      
      // Populate provider filter
      const providers = new Set();
      Object.values(DATA.models).forEach(m => providers.add(m.provider));
      const provSelect = document.getElementById('chartProvider');
      providers.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        provSelect.appendChild(opt);
      });
      
      // Render data tables
      renderDataTables();
      
      // Setup tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
          if (tab.dataset.tab === 'chart') updateChart();
        });
      });
      
      // Event listeners
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', updateAll);
        el.addEventListener('input', updateAll);
      });
      
      // Hardware change repopulates local models dropdown
      document.getElementById('hardware').addEventListener('change', () => {
        populateCalcDropdowns();
        updateAll();
      });
      
      // Chart-specific controls
      document.getElementById('chartBenchmark').addEventListener('change', updateChart);
      document.getElementById('chartType').addEventListener('change', updateChart);
      document.getElementById('chartProvider').addEventListener('change', updateChart);
      
      updateAll();
    }
    
    function populateCalcDropdowns() {
      const hwId = document.getElementById('hardware').value;
      
      // Local models (that have perf data for this hardware)
      const localSelect = document.getElementById('calcLocal');
      localSelect.innerHTML = '';
      Object.entries(DATA.models).forEach(([id, m]) => {
        if (m.local && m.local[hwId]) {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `${m.name} (${m.local[hwId].tokensPerSec} tok/s)`;
          localSelect.appendChild(opt);
        }
      });
      
      // Subscriptions
      const subSelect = document.getElementById('calcSub');
      subSelect.innerHTML = '';
      Object.entries(DATA.models).forEach(([id, m]) => {
        if (m.subscriptions) {
          Object.entries(m.subscriptions).forEach(([subId, sub]) => {
            const opt = document.createElement('option');
            opt.value = `${id}|${subId}`;
            opt.textContent = `${sub.name} ‚Üí ${m.name} ($${sub.monthlyPrice}/mo)`;
            subSelect.appendChild(opt);
          });
        }
      });
      
      // API models
      const apiSelect = document.getElementById('calcApi');
      apiSelect.innerHTML = '';
      Object.entries(DATA.models).forEach(([id, m]) => {
        if (m.api) {
          const opt = document.createElement('option');
          opt.value = id;
          const provider = m.api.provider ? ` via ${m.api.provider}` : '';
          opt.textContent = `${m.name}${provider} ($${m.api.inputPer1M}/M)`;
          apiSelect.appendChild(opt);
        }
      });
    }
    
    function renderDataTables() {
      // Models table
      let html = '';
      Object.values(DATA.models).forEach(m => {
        html += `<tr>
          <td><strong>${m.name}</strong></td>
          <td>${m.provider}</td>
          <td>${m.releaseDate}</td>
          <td><a href="${m.modelCard}" target="_blank">Link</a></td>
        </tr>`;
      });
      document.querySelector('#tableModels tbody').innerHTML = html;
      
      // Benchmarks table
      html = '';
      Object.values(DATA.models).forEach(m => {
        const bm = m.benchmarks || {};
        html += `<tr>
          <td>${m.name}</td>
          <td>${bm.arena_elo ? `<a href="${bm.arena_elo.source}" target="_blank">${bm.arena_elo.score}</a>` : '-'}</td>
          <td>${bm.aider_polyglot ? `<a href="${bm.aider_polyglot.source}" target="_blank">${bm.aider_polyglot.score}%</a>` : '-'}</td>
          <td>${bm.livebench ? `<a href="${bm.livebench.source}" target="_blank">${bm.livebench.score}%</a>` : '-'}</td>
          <td>${bm.mmlu ? `<a href="${bm.mmlu.source}" target="_blank">${bm.mmlu.score}%</a>` : '-'}</td>
        </tr>`;
      });
      document.querySelector('#tableBenchmarks tbody').innerHTML = html;
      
      // API table
      html = '';
      Object.values(DATA.models).filter(m => m.api).forEach(m => {
        html += `<tr>
          <td>${m.name}</td>
          <td>$${m.api.inputPer1M}</td>
          <td>$${m.api.outputPer1M}</td>
          <td><a href="${m.api.source}" target="_blank">Link</a></td>
        </tr>`;
      });
      document.querySelector('#tableApi tbody').innerHTML = html;
      
      // Local performance table
      html = '';
      Object.values(DATA.models).filter(m => m.local).forEach(m => {
        Object.entries(m.local).forEach(([hwId, perf]) => {
          const hw = DATA.hardware[hwId];
          html += `<tr>
            <td>${m.name}</td>
            <td>${hw ? hw.name : hwId}</td>
            <td>${perf.tokensPerSec}</td>
            <td>${perf.quantization || '-'}</td>
            <td>${perf.vramRequired || '-'}GB</td>
            <td><a href="${perf.source}" target="_blank">Link</a></td>
          </tr>`;
        });
      });
      document.querySelector('#tableLocal tbody').innerHTML = html;
      
      // Subscriptions table
      html = '';
      Object.values(DATA.models).filter(m => m.subscriptions).forEach(m => {
        Object.entries(m.subscriptions).forEach(([subId, sub]) => {
          const confClass = sub.confidence === 'low' ? 'confidence-low' : 
                           sub.confidence === 'medium' ? 'confidence-medium' : 'confidence-high';
          html += `<tr>
            <td>${m.name}</td>
            <td>${sub.name}</td>
            <td>$${sub.monthlyPrice}</td>
            <td>${sub.tokensPerDay ? formatNum(sub.tokensPerDay) : '?'}</td>
            <td class="${confClass}">${sub.confidence || 'low'}</td>
            <td style="max-width:200px;font-size:0.65rem">${sub.notes || ''}</td>
            <td><a href="${sub.source}" target="_blank">Link</a></td>
          </tr>`;
        });
      });
      document.querySelector('#tableSubs tbody').innerHTML = html;
      
      // Hardware table
      html = '';
      Object.entries(DATA.hardware).forEach(([id, hw]) => {
        html += `<tr>
          <td>${hw.name}</td>
          <td>$${hw.price}</td>
          <td>${hw.vram}GB</td>
          <td>${hw.year}</td>
          <td><a href="${hw.source}" target="_blank">Link</a></td>
        </tr>`;
      });
      document.querySelector('#tableHardware tbody').innerHTML = html;
    }
    
    function getScore(model, benchmarkId) {
      if (!model.benchmarks) return null;
      
      // Handle combined benchmark - average all normalized scores
      if (benchmarkId === '_combined') {
        const recommendedBenchmarks = Object.entries(DATA.benchmarks)
          .filter(([,b]) => b.recommended)
          .map(([id]) => id);
        
        let total = 0;
        let count = 0;
        
        recommendedBenchmarks.forEach(bmId => {
          if (model.benchmarks[bmId]) {
            const rawScore = model.benchmarks[bmId].score;
            const normalized = normalizeScore(rawScore, bmId);
            total += normalized;
            count++;
          }
        });
        
        if (count === 0) return null;
        return total / count; // Return average normalized score (0-100)
      }
      
      if (!model.benchmarks[benchmarkId]) return null;
      return model.benchmarks[benchmarkId].score;
    }
    
    // Normalize score to 0-100 range based on benchmark type
    function normalizeScore(score, benchmarkId) {
      // Combined scores are already normalized
      if (benchmarkId === '_combined') return score;
      
      const bm = DATA.benchmarks[benchmarkId];
      if (!bm) return score;
      
      if (bm.type === 'elo') {
        // Normalize ELO: 1000 = 0%, 1500 = 100%
        return Math.max(0, Math.min(100, (score - 1000) / 5));
      }
      // Percentage benchmarks are already 0-100
      return score;
    }
    
    function getDisplayScore(score, benchmarkId) {
      // Combined scores show as percentage
      if (benchmarkId === '_combined') {
        return `${score.toFixed(1)}% avg`;
      }
      
      const bm = DATA.benchmarks[benchmarkId];
      if (!bm) return `${score}`;
      
      if (bm.type === 'elo') {
        return `${score} ELO`;
      }
      return `${score}%`;
    }
    
    function updateAll() {
      updateCalcCards();
      renderCalculator();
      // Chart updates only when tab is visible
    }
    
    function updateCalcCards() {
      const hwId = document.getElementById('hardware').value;
      const hours = parseFloat(document.getElementById('hoursPerDay').value) || 16;
      const years = parseInt(document.getElementById('periodYears').value);
      const benchmarkId = document.getElementById('benchmark').value;
      const hw = DATA.hardware[hwId];
      
      if (!hw) return;
      
      // LOCAL calculation
      const localId = document.getElementById('calcLocal').value;
      const localModel = DATA.models[localId];
      if (localModel && localModel.local && localModel.local[hwId]) {
        const perf = localModel.local[hwId];
        const score = getScore(localModel, benchmarkId) || 0;
        const tokPerDay = perf.tokensPerSec * 3600 * hours;
        const tokTotal = tokPerDay * 365 * years;
        const adjusted = tokTotal * (normalizeScore(score, benchmarkId) / 100);
        const value = adjusted / hw.price;
        
        document.getElementById('calcLocalSteps').innerHTML = `
          <div class="calc-step"><span class="num">${perf.tokensPerSec}</span> tok/s √ó 3600 √ó <span class="num">${hours}</span>h = <span class="result">${formatNum(tokPerDay)}</span> tok/day</div>
          <div class="calc-step"><span class="num">${formatNum(tokPerDay)}</span> √ó 365 √ó <span class="num">${years}</span>y = <span class="result">${formatNum(tokTotal)}</span> total</div>
          <div class="calc-step"><span class="num">${formatNum(tokTotal)}</span> √ó <span class="num">${getDisplayScore(score, benchmarkId)}</span> quality = <span class="result">${formatNum(adjusted)}</span></div>
          <div class="calc-step"><span class="num">${formatNum(adjusted)}</span> √∑ $<span class="num">${hw.price}</span> = <span class="result">${formatNum(value)}</span></div>
        `;
        document.getElementById('calcLocalValue').textContent = formatNum(value);
      }
      
      // SUBSCRIPTION calculation
      const subVal = document.getElementById('calcSub').value;
      if (subVal) {
        const [modelId, subId] = subVal.split('|');
        const model = DATA.models[modelId];
        const sub = model?.subscriptions?.[subId];
        if (sub && sub.tokensPerDay) {
          const score = getScore(model, benchmarkId) || 0;
          const tokTotal = sub.tokensPerDay * 365 * years;
          const totalCost = sub.monthlyPrice * 12 * years;
          const adjusted = tokTotal * (normalizeScore(score, benchmarkId) / 100);
          const value = adjusted / totalCost;
          
          document.getElementById('calcSubSteps').innerHTML = `
            <div class="calc-step"><span class="num">${formatNum(sub.tokensPerDay)}</span> tok/day √ó 365 √ó <span class="num">${years}</span>y = <span class="result">${formatNum(tokTotal)}</span></div>
            <div class="calc-step"><span class="num">${formatNum(tokTotal)}</span> √ó <span class="num">${getDisplayScore(score, benchmarkId)}</span> quality = <span class="result">${formatNum(adjusted)}</span></div>
            <div class="calc-step">$<span class="num">${sub.monthlyPrice}</span>/mo √ó 12 √ó <span class="num">${years}</span>y = $<span class="result">${totalCost}</span></div>
            <div class="calc-step"><span class="num">${formatNum(adjusted)}</span> √∑ $<span class="num">${totalCost}</span> = <span class="result">${formatNum(value)}</span></div>
          `;
          document.getElementById('calcSubValue').textContent = formatNum(value);
        }
      }
      
      // API calculation
      const apiId = document.getElementById('calcApi').value;
      const apiModel = DATA.models[apiId];
      if (apiModel && apiModel.api) {
        const score = getScore(apiModel, benchmarkId) || 0;
        const tokPerDollar = 1000000 / apiModel.api.inputPer1M;
        const value = tokPerDollar * (normalizeScore(score, benchmarkId) / 100);
        
        document.getElementById('calcApiSteps').innerHTML = `
          <div class="calc-step">1,000,000 √∑ $<span class="num">${apiModel.api.inputPer1M}</span>/M = <span class="result">${formatNum(tokPerDollar)}</span> tok/$</div>
          <div class="calc-step"><span class="num">${formatNum(tokPerDollar)}</span> √ó <span class="num">${getDisplayScore(score, benchmarkId)}</span> quality = <span class="result">${formatNum(value)}</span></div>
        `;
        document.getElementById('calcApiValue').textContent = formatNum(value);
      }
    }
    
    function renderCalculator() {
      const hwId = document.getElementById('hardware').value;
      const hours = parseFloat(document.getElementById('hoursPerDay').value) || 16;
      const years = parseInt(document.getElementById('periodYears').value);
      const benchmarkId = document.getElementById('benchmark').value;
      const hw = DATA.hardware[hwId];
      
      if (!hw) return;
      
      // Calculate values for all models
      let results = [];
      
      Object.values(DATA.models).forEach(model => {
        const score = getScore(model, benchmarkId);
        if (!score) return;
        
        // API value
        if (model.api) {
          const tokPerDollar = 1000000 / model.api.inputPer1M;
          const value = tokPerDollar * (normalizeScore(score, benchmarkId) / 100);
          const apiProvider = model.api.provider ? ` (${model.api.provider})` : '';
          results.push({
            model: model.name + apiProvider,
            type: 'api',
            value: value,
            score: score,
            displayScore: getDisplayScore(score, benchmarkId),
            details: `$${model.api.inputPer1M}/M input`
          });
        }
        
        // Local value
        if (model.local && model.local[hwId]) {
          const perf = model.local[hwId];
          const tokTotal = perf.tokensPerSec * 3600 * hours * 365 * years;
          const value = (tokTotal / hw.price) * (normalizeScore(score, benchmarkId) / 100);
          results.push({
            model: model.name,
            type: 'local',
            value: value,
            score: score,
            displayScore: getDisplayScore(score, benchmarkId),
            details: `${perf.tokensPerSec} tok/s on ${hw.name}`
          });
        }
        
        // Subscription values
        if (model.subscriptions) {
          Object.values(model.subscriptions).forEach(sub => {
            if (!sub.tokensPerDay) return;
            const tokTotal = sub.tokensPerDay * 365 * years;
            const cost = sub.monthlyPrice * 12 * years;
            const value = (tokTotal / cost) * (normalizeScore(score, benchmarkId) / 100);
            results.push({
              model: model.name,
              type: 'subscription',
              subName: sub.name,
              value: value,
              score: score,
              displayScore: getDisplayScore(score, benchmarkId),
              confidence: sub.confidence,
              details: `$${sub.monthlyPrice}/mo`
            });
          });
        }
      });
      
      // Sort by value
      results.sort((a, b) => b.value - a.value);
      
      // Render
      const maxVal = results[0]?.value || 1;
      let html = '<div style="display:flex;flex-direction:column;gap:0.5rem">';
      
      results.forEach((r, i) => {
        const pct = (r.value / maxVal) * 100;
        const typeColor = r.type === 'api' ? '#ff6b6b' : r.type === 'local' ? '#00ff88' : '#7c3aed';
        const typeIcon = r.type === 'api' ? 'üîå' : r.type === 'local' ? 'üñ•Ô∏è' : 'üí≥';
        const typeLabel = r.type === 'api' ? 'API' : r.type === 'local' ? 'Local' : 'Sub';
        const confWarn = r.confidence === 'low' ? ' ‚ö†Ô∏è' : '';
        const label = r.subName ? `${r.subName} ‚Üí ${r.model}` : r.model;
        
        html += `
          <div style="display:flex;align-items:center;gap:1rem">
            <div style="width:60px;font-size:0.65rem;color:${typeColor};font-weight:600">${typeIcon} ${typeLabel}</div>
            <div style="width:220px;font-size:0.75rem">${label}${confWarn}</div>
            <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:4px;height:24px;overflow:hidden">
              <div style="width:${pct}%;height:100%;background:${typeColor};display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:0.7rem;font-weight:600">
                ${formatNum(r.value)}
              </div>
            </div>
            <div style="width:150px;font-size:0.65rem;color:#888">${r.details} (${r.displayScore})</div>
          </div>`;
      });
      
      html += '</div>';
      document.getElementById('calculatorContent').innerHTML = html;
    }
    
    function updateChart() {
      const hwId = document.getElementById('hardware').value;
      const hours = parseFloat(document.getElementById('hoursPerDay').value) || 16;
      const years = parseInt(document.getElementById('periodYears').value);
      const benchmarkId = document.getElementById('chartBenchmark').value;
      const typeFilter = document.getElementById('chartType').value;
      const providerFilter = document.getElementById('chartProvider').value;
      const hw = DATA.hardware[hwId];
      
      if (!hw) return;
      
      let dataPoints = [];
      
      Object.values(DATA.models).forEach(model => {
        if (providerFilter !== 'all' && model.provider !== providerFilter) return;
        
        const score = getScore(model, benchmarkId);
        if (!score) return;
        
        const date = new Date(model.releaseDate);
        
        // API
        if (model.api && (typeFilter === 'all' || typeFilter === 'api')) {
          const tokPerDollar = 1000000 / model.api.inputPer1M;
          const normalizedPct = normalizeScore(score, benchmarkId);
          const value = tokPerDollar * (normalizedPct / 100);
          dataPoints.push({
            name: model.name,
            provider: model.provider,
            type: 'api',
            date: date,
            value: value,
            calc: {
              step1: `Tokens per $: 1M √∑ $${model.api.inputPer1M} = ${formatNum(tokPerDollar)}`,
              step2: `Quality-adjusted: ${formatNum(tokPerDollar)} √ó ${normalizedPct.toFixed(1)}% = ${formatNum(value)} tok/$`
            }
          });
        }
        
        // Local
        if (model.local && model.local[hwId] && (typeFilter === 'all' || typeFilter === 'local')) {
          const perf = model.local[hwId];
          const tokPerDay = perf.tokensPerSec * 3600 * hours;
          const tokTotal = tokPerDay * 365 * years;
          const normalizedPct = normalizeScore(score, benchmarkId);
          const adjusted = tokTotal * (normalizedPct / 100);
          const value = adjusted / hw.price;
          dataPoints.push({
            name: `${model.name} (local)`,
            provider: model.provider,
            type: 'local',
            date: date,
            value: value,
            calc: {
              step1: `Tokens/day: ${perf.tokensPerSec} tok/s √ó ${hours}h = ${formatNum(tokPerDay)}`,
              step2: `Total tokens: ${formatNum(tokPerDay)} √ó 365 √ó ${years}y = ${formatNum(tokTotal)}`,
              step3: `Quality-adjusted: ${formatNum(tokTotal)} √ó ${normalizedPct.toFixed(1)}% = ${formatNum(adjusted)}`,
              step4: `Per $ (hw $${hw.price}): ${formatNum(adjusted)} √∑ $${hw.price} = ${formatNum(value)} tok/$`
            }
          });
        }
        
        // Subscriptions
        if (model.subscriptions && (typeFilter === 'all' || typeFilter === 'subscription')) {
          Object.values(model.subscriptions).forEach(sub => {
            if (!sub.tokensPerDay) return;
            const tokTotal = sub.tokensPerDay * 365 * years;
            const cost = sub.monthlyPrice * 12 * years;
            const normalizedPct = normalizeScore(score, benchmarkId);
            const adjusted = tokTotal * (normalizedPct / 100);
            const value = adjusted / cost;
            dataPoints.push({
              name: `${sub.name} ‚Üí ${model.name}`,
              provider: model.provider,
              type: 'subscription',
              date: date,
              value: value,
              estimated: sub.confidence === 'low',
              calc: {
                step1: `Tokens/day: ${formatNum(sub.tokensPerDay)} (limit)`,
                step2: `Total tokens: ${formatNum(sub.tokensPerDay)} √ó 365 √ó ${years}y = ${formatNum(tokTotal)}`,
                step3: `Total cost: $${sub.monthlyPrice}/mo √ó 12 √ó ${years}y = $${cost}`,
                step4: `Quality-adjusted: ${formatNum(tokTotal)} √ó ${normalizedPct.toFixed(1)}% = ${formatNum(adjusted)}`,
                step5: `Per $: ${formatNum(adjusted)} √∑ $${cost} = ${formatNum(value)} tok/$`
              }
            });
          });
        }
      });
      
      // Group by provider+type
      const groups = {};
      dataPoints.forEach(d => {
        const key = `${d.provider}-${d.type}`;
        if (!groups[key]) groups[key] = { provider: d.provider, type: d.type, points: [] };
        groups[key].points.push(d);
      });
      
      Object.values(groups).forEach(g => g.points.sort((a, b) => a.date - b.date));
      
      const datasets = Object.values(groups).map(g => {
        const color = PROVIDER_COLORS[g.provider] || '#888';
        const typeLabel = g.type === 'api' ? '' : g.type === 'local' ? ' (Local)' : ' (Sub)';
        return {
          label: g.provider + typeLabel,
          data: g.points.map(p => ({ x: p.date, y: p.value, ...p })),
          backgroundColor: color,
          borderColor: color,
          borderWidth: 2,
          pointRadius: 7,
          showLine: true,
          tension: 0.2,
          borderDash: g.type === 'subscription' ? [5, 5] : [],
          pointStyle: g.type === 'local' ? 'rect' : g.type === 'subscription' ? 'triangle' : 'circle',
        };
      });
      
      if (chart) chart.destroy();
      
      chart = new Chart(document.getElementById('valueChart'), {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', time: { unit: 'quarter' }, title: { display: true, text: 'Release Date', color: '#888' }, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { type: 'logarithmic', title: { display: true, text: 'Quality-Adjusted Tokens per $', color: '#888' }, ticks: { color: '#888', callback: v => formatNum(v) }, grid: { color: 'rgba(255,255,255,0.05)' } }
          },
          plugins: {
            tooltip: {
              callbacks: {
                title: ctx => ctx[0].raw.name + (ctx[0].raw.estimated ? ' ‚ö†Ô∏è' : ''),
                label: ctx => {
                  const d = ctx.raw;
                  const lines = [`Value: ${formatNum(d.value)} tok/$`];
                  if (d.calc) {
                    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    Object.values(d.calc).forEach(step => lines.push(step));
                  }
                  return lines;
                }
              }
            },
            legend: { display: true, labels: { color: '#888', usePointStyle: true } }
          }
        }
      });
    }
    
    // Start loading
    loadData();
    </script>
</body>
</html>
